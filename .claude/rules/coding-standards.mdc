---
description: Mandatory coding standards for all TypeScript/React code - performance optimization, code structure, and Next.js best practices
globs:
  - "**/*.{ts,tsx}"
alwaysApply: true
---

# Coding Standards (MANDATORY)

## Performance Optimization

- **Always use `React.memo`** for all functional components
- **Always use `useMemo`** for computed values, object creation, and inline objects/arrays
- **Always use `useCallback`** for all function definitions passed as props or dependencies
- **Set displayName** for all memoized components for better debugging

## Code Structure

- **Always use `type` instead of `interface`** for all type definitions
- **Never use `export default`** - always use named exports
- **Reusable components**: create reusable whenever possible
- **Import components** using named imports: `import { Button } from '@/components/ui/button'`
- **Always use SWR** for data fetching instead of custom hooks or useState
- **Always use react-hook-form** for form management with Controller components

## Next.js Specific

- Use **Server Components** by default unless interactivity is required
- Use **Client Components** (`'use client'`) only when needed (hooks, event handlers, browser APIs)
- Protect all routes with **middleware.ts** (authentication + i18n)
- Use **Server Actions** for mutations (deal creation, document upload, Q&A)
- Use **API Routes** only for webhooks (Stripe) and external integrations

## DDFlow-Specific Patterns

- **Deal Permissions**: Always check user's role and side (buyer/seller) before showing UI
- **RLS Policies**: Rely on Supabase RLS for data security, but also check permissions in UI
- **Document Status**: Use enum types for status (pending, uploaded, in_review, approved)
- **Real-time Updates**: Use router.refresh() after mutations to update Server Component data
- **Optimistic Updates**: Update UI immediately for better UX, sync in background

## Example

```tsx
type DealCardProps = {
  deal: Deal;
  onSelect: (id: string) => void;
  isSelected: boolean;
};

export const DealCard = React.memo(({ deal, onSelect, isSelected }: DealCardProps) => {
  const formattedDate = useMemo(() => dayjs(deal.created_at).fromNow(), [deal.created_at]);
  const handleClick = useCallback(() => onSelect(deal.id), [onSelect, deal.id]);

  return (
    <Card onClick={handleClick} className={isSelected ? 'border-blue-600' : ''}>
      <CardHeader>
        <CardTitle>{deal.name}</CardTitle>
        <p className="text-sm text-slate-500">{formattedDate}</p>
      </CardHeader>
    </Card>
  );
});
DealCard.displayName = "DealCard";
```
