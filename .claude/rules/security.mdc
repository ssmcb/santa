---
description: Security best practices for Secret Santa App - authentication, session management, and MongoDB security
globs:
  - "**/*.{ts,tsx}"
  - "app/api/**/*"
  - "middleware.ts"
alwaysApply: true
---

# Security Standards (MANDATORY)

## Authentication & Authorization

- **Password-less Auth**: Use magic link authentication with verification codes
- **Session Management**: Server-side session validation using iron-session (encrypted cookies)
- **Middleware Protection**: All protected routes must be validated by middleware.ts
- **Cookie Settings**: Use secure, httpOnly, sameSite cookies
- **Session Validation**: Check for valid session on every protected route and API call
- **Code Expiration**: Verification codes must expire after 30 minutes

## Permission System

- **Group Owner**: Only the group owner can run the lottery and manage the group
- **Participant Access**: Participants can only see their own assignment after lottery is run
- **Invite Validation**: Always validate invite_id before allowing users to join a group
- **Server-side Checks**: Always verify permissions in API routes and Server Actions
- **Client-side UI**: Hide/disable UI elements based on permissions for better UX

## MongoDB Security

- **Connection**: Always use environment variables for MongoDB connection string
- **Input Validation**: Validate and sanitize all inputs before database queries
- **Mongoose Schema Validation**: Use Mongoose schemas with proper validation rules
- **Unique Constraints**: Enforce unique constraints on critical fields (email, invite_id)
- **Indexes**: Add indexes on frequently queried fields (email, group_id, invite_id)
- **NoSQL Injection**: Use parameterized queries and avoid string concatenation

## Email Security

- **AWS SES**: Always use verified sender email addresses
- **Link Expiration**: Email verification links must expire after 30 minutes
- **No Sensitive Data**: Never include sensitive information in email content
- **Rate Limiting**: Implement rate limiting to prevent email spam

## API Route Security

- **Session Check**: Every protected API route must validate the session cookie
- **Input Validation**: Validate all request bodies and query parameters with Zod
- **Error Messages**: Don't leak sensitive information in error responses
- **CORS**: Restrict CORS to your own domain only
- **Rate Limiting**: Implement rate limiting on sensitive endpoints

## Verification Code Security

- **Uniqueness**: Generate cryptographically secure random codes
- **One-time Use**: Clear verification codes after successful use
- **Expiration**: Enforce 30-minute expiration on all codes
- **No Reuse**: Never allow the same code to be used twice

## Environment Variables

Never commit these to git:
- `MONGODB_URI` - MongoDB connection string (secret)
- `SESSION_SECRET` - iron-session encryption secret (secret)
- `AWS_ACCESS_KEY_ID` - AWS access key (secret)
- `AWS_SECRET_ACCESS_KEY` - AWS secret key (secret)
- `AWS_REGION` - AWS region (e.g., us-east-1)
- `AWS_SES_SENDER_EMAIL` - Verified sender email address
- `NEXT_PUBLIC_APP_URL` - Application URL (public)
